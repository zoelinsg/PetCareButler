{% extends "base.html" %}

{% block title %}日常記錄{% endblock %}

{% block content %}
<style>
  /* 讓表格最右邊操作欄固定，不會被切掉 */
  .table-sticky-actions {
    position: sticky;
    right: 0;
    z-index: 2;
    background: #fff;
    /* 右側陰影：讓使用者知道這欄是浮在上面 */
    box-shadow: -8px 0 12px rgba(0,0,0,.06);
  }
  thead .table-sticky-actions {
    z-index: 3;
    background: var(--bs-table-bg, #f8f9fa);
  }
  td.table-sticky-actions, th.table-sticky-actions {
    min-width: 170px;
    white-space: nowrap;
  }
  .actions-btns .btn { white-space: nowrap; }
</style>

<div class="row">
  <div class="col-12">

    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-end gap-3 mb-3">
      <div>
        <h1 class="h4 fw-semibold mb-1">日常記錄</h1>
        <div class="text-muted small">記錄飲水、飯量、體重、排便、運動與用藥</div>
      </div>

      <form class="d-flex flex-wrap flex-lg-nowrap gap-2 align-items-end" method="get">
        <div style="min-width: 220px;">
          <label class="form-label small text-muted mb-1">寵物</label>
          <select class="form-select form-select-sm" name="pet">
            <option value="">全部寵物</option>
            {% for p in pets %}
              <option value="{{ p.id }}" {% if pet_id|stringformat:"s" == p.id|stringformat:"s" %}selected{% endif %}>
                {{ p.name }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div style="min-width: 280px; max-width: 420px;" class="flex-grow-1">
          <label class="form-label small text-muted mb-1">搜尋</label>
          <input class="form-control form-control-sm"
                 name="q" value="{{ q }}"
                 placeholder="搜尋：備註 / 營養品 / 用藥">
        </div>

        <div class="d-flex gap-2">
          <button class="btn btn-primary btn-sm" type="submit">搜尋</button>
          <a class="btn btn-outline-primary btn-sm text-nowrap" href="{% url 'care_record_create' %}">新增記錄</a>
        </div>
      </form>
    </div>

    <div class="card shadow-sm border-0">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0 align-middle">
            <thead class="table-light">
              <tr>
                <th class="ps-3">日期</th>
                <th>寵物</th>
                <th class="text-end">重(kg)</th>
                <th class="text-end">水(ml)</th>
                <th class="text-end">飯(g)</th>
                <th class="text-end">上廁所次數</th>
                <th>排便狀況</th>
                <th>心情</th>
                <th>營養品</th>
                <th>用藥</th>
                <th class="table-sticky-actions text-end pe-3">操作</th>
              </tr>
            </thead>

            <tbody>
              {% for r in records %}
              <tr>
                <td class="ps-3 fw-semibold">
                  {% if r.record_date %}
                    {{ r.record_date|date:"Y/m/d" }}
                  {% else %}
                    {% if r.recorded_at %}{{ r.recorded_at|date:"Y/m/d" }}{% else %}—{% endif %}
                  {% endif %}
                </td>

                <td class="fw-semibold">{{ r.pet.name }}</td>

                <td class="text-end">{% if r.weight_kg %}{{ r.weight_kg }}{% else %}—{% endif %}</td>
                <td class="text-end">{% if r.water_ml %}{{ r.water_ml }}{% else %}—{% endif %}</td>
                <td class="text-end">{% if r.food_g %}{{ r.food_g }}{% else %}—{% endif %}</td>

                <td class="text-end">{% if r.toilet_count is not None %}{{ r.toilet_count }}{% else %}—{% endif %}</td>

                <td>{% if r.poop_status %}{{ r.get_poop_status_display|default:r.poop_status }}{% else %}—{% endif %}</td>
                <td>{% if r.mood %}{{ r.get_mood_display|default:r.mood }}{% else %}—{% endif %}</td>

                <td class="text-muted">
                  {% if r.supplements_display %}
                    {{ r.supplements_display }}
                  {% elif r.supplements %}
                    {{ r.supplements }}
                  {% else %}
                    —
                  {% endif %}
                </td>

                <td class="text-muted">{% if r.medicine %}{{ r.medicine }}{% else %}—{% endif %}</td>

                <td class="table-sticky-actions text-end pe-3">
                  <div class="btn-group btn-group-sm actions-btns" role="group">
                    <a class="btn btn-primary" href="{% url 'care_record_detail' r.id %}">查看</a>
                    <a class="btn btn-outline-primary" href="{% url 'care_record_update' r.id %}">編輯</a>
                    <a class="btn btn-outline-danger" href="{% url 'care_record_delete' r.id %}">刪除</a>
                  </div>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="11" class="text-center text-muted py-5">目前沒有符合條件的日常記錄</td>
              </tr>
              {% endfor %}
            </tbody>

          </table>
        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}
